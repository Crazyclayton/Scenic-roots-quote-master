<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lawn Care CRM & Quoting App</title>
<style>
  :root{
    --accent:#2a9d8f;
    --accent-dark:#264653;
    --nav-heading:#cdeae6;
  }
  body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f8f8f8;color:#333}
  header{background:#2a9d8f;color:#fff;padding:1rem;text-align:center}
  main{padding:1rem}
  section{display:none}
  section.active{display:block}
  .card{background:#fff;border-radius:6px;padding:1rem;box-shadow:0 2px 6px rgba(0,0,0,.08);margin:12px 0}
  label{display:block;margin:.4rem 0 .2rem}
  input[type=text],input[type=email],input[type=number],input[type=password],input[type=time],input[type=date],select,textarea{
    width:100%;box-sizing:border-box;padding:.5rem;border:1px solid #ccc;border-radius:4px;background:#fff
  }
  textarea{min-height:70px}
  button{cursor:pointer}
  button.primary{background:#2a9d8f;color:#fff;border:none;border-radius:4px;padding:.6rem 1rem}
  button.secondary{background:#e9c46a;border:none;border-radius:4px;padding:.5rem .8rem}
  table{width:100%;border-collapse:collapse;margin-top:.6rem;background:#fff}
  th,td{border:1px solid #ddd;padding:.45rem;text-align:left}
  th{background:#e9c46a}
  .inline-fields{display:flex;gap:10px;flex-wrap:wrap}
  .inline-fields>div{flex:1 1 220px}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .hidden{display:none}
  .muted{opacity:.7}
  .small{font-size:.9rem}

  /* Grouped nav */
  nav{display:flex;flex-wrap:wrap;background:#264653;padding:.5rem .75rem;gap:8px}
  nav .nav-group{display:flex;align-items:center;flex-wrap:wrap;border:1px solid rgba(255,255,255,.15);border-radius:6px;padding:6px 8px}
  nav .nav-heading{font-size:.8rem;font-weight:700;text-transform:uppercase;color:var(--nav-heading);margin-right:6px}
  nav .nav-group button{margin-right:6px;white-space:nowrap}
  nav button{background:transparent;border:none;color:#fff;padding:.8rem .6rem;font-size:1rem}
  nav button:hover{background:rgba(255,255,255,.1);border-radius:4px}
  nav button.active{background:var(--accent);border-radius:4px}
  @media (max-width:600px){nav button{font-size:.85rem}}
</style>
</head>
<body>
  <header><h1>Lawn Care CRM &amp; Quoting App</h1></header>

  <!-- Grouped Navigation -->
  <nav id="main-nav">
    <div class="nav-group">
      <span class="nav-heading">Sales &amp; CRM</span>
      <button id="nav-clients" class="active">Clients</button>
      <button id="nav-services">Services</button>
      <button id="nav-quotes">Quotes</button>
      <button id="nav-leads">Leads</button>
    </div>
    <div class="nav-group">
      <span class="nav-heading">Operations</span>
      <button id="nav-jobs">Jobs</button>
      <button id="nav-employees">Employees</button>
      <button id="nav-tasks">Tasks</button>
    </div>
    <div class="nav-group">
      <span class="nav-heading">Finance</span>
      <button id="nav-invoices">Invoices</button>
      <button id="nav-expenses">Expenses</button>
      <button id="nav-reports">Reports</button>
    </div>
    <div class="nav-group">
      <span class="nav-heading">Access</span>
      <button id="nav-portals">Portals</button>
    </div>
  </nav>

  <main>
    <!-- CLIENTS -->
    <section id="section-clients" class="active">
      <h2>Clients</h2>
      <div class="card">
        <form id="client-form">
          <input type="hidden" id="client-id" />
          <label for="client-name">Name</label>
          <input id="client-name" type="text" required />
          <label for="client-company">Company</label>
          <input id="client-company" type="text" />
          <label for="client-email">Email</label>
          <input id="client-email" type="email" />
          <label for="client-phone">Phone</label>
          <input id="client-phone" type="text" />
          <label for="client-address">Address</label>
          <textarea id="client-address"></textarea>
          <!-- GPS -->
          <div class="inline-fields">
            <div><button type="button" class="secondary" id="use-current-location">Use Current Location</button></div>
            <div><input id="client-lat" type="text" placeholder="lat" class="hidden" /></div>
            <div><input id="client-lng" type="text" placeholder="lng" class="hidden" /></div>
          </div>
          <div class="inline-fields" style="margin-top:.5rem">
            <button type="submit" class="primary" id="save-client-btn">Save Client</button>
            <button type="button" class="secondary hidden" id="cancel-client-btn">Cancel</button>
          </div>
        </form>
      </div>
      <table id="clients-table">
        <thead><tr><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- SERVICES -->
    <section id="section-services">
      <h2>Services</h2>
      <div class="card">
        <form id="service-form">
          <input type="hidden" id="service-id" />
          <label for="service-name">Service Name</label>
          <input id="service-name" required />
          <label for="service-price">Price (per unit)</label>
          <input id="service-price" type="number" step="0.01" min="0" required/>
          <label for="service-description">Description</label>
          <textarea id="service-description"></textarea>
          <div style="margin-top:.5rem">
            <button class="primary" type="submit">Save Service</button>
            <button class="secondary hidden" type="button" id="cancel-service-btn">Cancel</button>
          </div>
        </form>
      </div>
      <table id="services-table">
        <thead><tr><th>Service</th><th>Price</th><th>Description</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- QUOTES -->
    <section id="section-quotes">
      <h2>Quotes</h2>
      <div class="card">
        <form id="quote-form">
          <input type="hidden" id="quote-id" />
          <div class="inline-fields">
            <div>
              <label for="quote-client">Client</label>
              <select id="quote-client"></select>
            </div>
            <div>
              <label for="quote-date">Date</label>
              <input id="quote-date" type="date"/>
            </div>
          </div>
          <h4>Items</h4>
          <table class="quote-items-table" id="quote-items">
            <thead><tr><th>Service</th><th>Qty</th><th>Unit Price</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <button type="button" class="secondary" id="add-quote-item">Add Item</button>
          <label for="quote-notes" style="margin-top:.6rem">Work Description / Notes</label>
          <textarea id="quote-notes"></textarea>
          <div class="inline-fields" style="margin-top:.6rem">
            <div><strong>Total: $<span id="quote-total">0.00</span></strong></div>
          </div>
          <div style="margin-top:.6rem">
            <button class="primary" type="submit">Save Quote</button>
            <button class="secondary hidden" type="button" id="cancel-quote-btn">Cancel</button>
          </div>
        </form>
      </div>
      <table id="quotes-table">
        <thead><tr><th>Client</th><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- JOBS -->
    <section id="section-jobs">
      <h2>Jobs</h2>
      <div class="card">
        <form id="job-form">
          <input type="hidden" id="job-id" />
          <div class="inline-fields">
            <div>
              <label for="job-client">Client</label>
              <select id="job-client"></select>
            </div>
            <div>
              <label for="job-date">Date</label>
              <input id="job-date" type="date"/>
            </div>
          </div>
          <label for="job-desc">Description</label>
          <textarea id="job-desc"></textarea>
          <div style="margin-top:.6rem">
            <button class="primary" type="submit">Save Job</button>
            <button class="secondary hidden" id="cancel-job-btn" type="button">Cancel</button>
          </div>
        </form>
      </div>
      <table id="jobs-table">
        <thead><tr><th>Date</th><th>Client</th><th>Description</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- EMPLOYEES & TIME CLOCK -->
    <section id="section-employees">
      <h2>Employees &amp; Time Clock</h2>
      <div class="card">
        <form id="employee-form">
          <input type="hidden" id="employee-id"/>
          <div class="inline-fields">
            <div>
              <label for="employee-name">Name</label>
              <input id="employee-name" required />
            </div>
            <div>
              <label for="employee-role">Role</label>
              <input id="employee-role" />
            </div>
            <div>
              <label for="employee-rate">Hourly Rate</label>
              <input id="employee-rate" type="number" step="0.01" min="0" placeholder="0.00"/>
            </div>
            <div>
              <label for="employee-pin">PIN (4–6 digits)</label>
              <input id="employee-pin" type="password" minlength="4" maxlength="6" inputmode="numeric" placeholder="e.g., 1234"/>
            </div>
          </div>
          <div style="margin-top:.6rem">
            <button class="primary" type="submit">Save Employee</button>
            <button class="secondary hidden" type="button" id="cancel-employee-btn">Cancel</button>
          </div>
        </form>
      </div>

      <table id="employees-table">
        <thead><tr><th>Name</th><th>Role</th><th>Rate</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="card">
        <h3>Time Clock</h3>
        <label for="clock-employee">Employee</label>
        <select id="clock-employee"></select><br/>
        <button class="primary" id="clock-in-btn" style="margin-top:.5rem">Clock In</button>
        <button class="secondary" id="clock-out-btn" style="margin-top:.5rem">Clock Out</button>
      </div>

      <h3>Time Logs</h3>
      <table id="timelogs-table">
        <thead><tr><th>Employee</th><th>Date</th><th>Clock In</th><th>Clock Out</th><th>Hours</th><th>Pay</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <!-- Edit Time Log Modal -->
      <div id="timelog-edit-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center">
        <div style="background:#fff;padding:1rem;border-radius:8px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.25)">
          <h3>Edit Time Log</h3>
          <form id="timelog-edit-form">
            <input type="hidden" id="edit-timelog-id"/>
            <label for="edit-timelog-date">Date</label>
            <input id="edit-timelog-date" type="date" required/>
            <label for="edit-timelog-start">Start Time</label>
            <input id="edit-timelog-start" type="time" required/>
            <label for="edit-timelog-end">End Time</label>
            <input id="edit-timelog-end" type="time" required/>
            <label for="edit-timelog-hours">Hours (optional)</label>
            <input id="edit-timelog-hours" type="number" step="0.01" min="0"/>
            <div style="margin-top:.7rem;display:flex;justify-content:flex-end;gap:.5rem">
              <button class="secondary" type="button" id="cancel-timelog-edit-btn">Cancel</button>
              <button class="primary" type="submit">Save</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- INVOICES -->
    <section id="section-invoices">
      <h2>Invoices</h2>
      <button class="primary" id="new-invoice-btn">Create New Invoice</button>
      <table id="invoices-table" style="margin-top:.6rem">
        <thead><tr><th>#</th><th>Date</th><th>Client</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>

      <!-- modal -->
      <div id="invoice-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center">
        <div style="background:#fff;padding:1rem;border-radius:8px;max-width:560px;width:95%;box-shadow:0 8px 32px rgba(0,0,0,.25)">
          <h3 id="invoice-modal-title">New Invoice</h3>
          <form id="invoice-form">
            <input type="hidden" id="invoice-id" />
            <div class="inline-fields">
              <div>
                <label for="invoice-client">Client</label>
                <select id="invoice-client"></select>
              </div>
              <div>
                <label for="invoice-date">Date</label>
                <input id="invoice-date" type="date"/>
              </div>
              <div>
                <label for="invoice-status">Status</label>
                <select id="invoice-status">
                  <option>Unpaid</option><option>Paid</option>
                </select>
              </div>
            </div>

            <h4 style="margin-top:.6rem">Items</h4>
            <table id="invoice-items">
              <thead><tr><th>Service</th><th>Qty</th><th>Unit</th><th>Total</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
            <button type="button" class="secondary" id="add-invoice-item">Add Item</button>

            <div style="margin-top:.6rem"><strong>Total: $<span id="invoice-total">0.00</span></strong></div>
            <div style="margin-top:.6rem;display:flex;justify-content:flex-end;gap:.5rem">
              <button type="button" class="secondary" id="cancel-invoice-btn">Cancel</button>
              <button type="submit" class="primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="section-expenses">
      <h2>Expenses</h2>
      <<div class="card">
        <form id="expense-form">
          <input type="hidden" id="expense-id"/>
          <div class="inline-fields">
            <div><label for="expense-date">Date</label><input id="expense-date" type="date"/></div>
            <div><label for="expense-desc">Description</label><input id="expense-desc" type="text"/></div>
            <div><label for="expense-amount">Amount</label><input id="expense-amount" type="number" step="0.01" min="0"/></div>
          </div>
          <div style="margin-top:.6rem"><button class="primary" type="submit">Add Expense</button></div>
        </form>
      </div>
      <table id="expenses-table">
        <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- LEADS -->
    <section id="section-leads">
      <h2>Leads</h2>
      <div class="card">
        <form id="lead-form">
          <input type="hidden" id="lead-id"/>
          <label for="lead-name">Name</label>
          <input id="lead-name"/>
          <label for="lead-contact">Contact (email/phone)</label>
          <input id="lead-contact"/>
          <label for="lead-notes">Notes</label>
          <textarea id="lead-notes"></textarea>
          <div style="margin-top:.6rem">
            <button class="primary" type="submit">Save Lead</button>
            <button class="secondary hidden" type="button" id="cancel-lead-btn">Cancel</button>
          </div>
        </form>
      </div>
      <table id="leads-table">
        <thead><tr><th>Name</th><th>Contact</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- TASKS -->
    <section id="section-tasks">
      <h2>Tasks &amp; Reminders</h2>
      <div class="card">
        <form id="task-form">
          <input type="hidden" id="task-id"/>
          <label for="task-title">Task</label>
          <input id="task-title"/>
          <label for="task-due">Due Date</label>
          <input id="task-due" type="date"/>
          <div style="margin-top:.6rem">
            <button class="primary" type="submit">Save Task</button>
            <button class="secondary hidden" type="button" id="cancel-task-btn">Cancel</button>
          </div>
        </form>
      </div>
      <table id="tasks-table">
        <thead><tr><th>Task</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- REPORTS -->
    <section id="section-reports">
      <h2>Reports</h2>
      <div id="report-content" class="card"></div>
    </section>

    <!-- PORTALS -->
    <section id="section-portals">
      <h2>Portals</h2>

      <div class="card">
        <h3>Client Portal</h3>
        <div class="inline-fields">
          <div><label for="portal-client-select">Select Client</label><select id="portal-client-select"></select></div>
          <div><label>&nbsp;</label><button class="primary" id="open-client-portal">Open Client View</button></div>
        </div>
        <p class="small muted">Tip: open via URL parameter <code>?client=&lt;id&gt;</code></p>

        <div id="client-portal-view" class="hidden">
          <h4 id="cpv-title"></h4>
          <h5>Quotes</h5>
          <table id="cpv-quotes"><thead><tr><th>Date</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
          <h5 style="margin-top:14px;">Invoices</h5>
          <table id="cpv-invoices"><thead><tr><th>Date</th><th>Total</th><th>Status</th></tr></thead><tbody></tbody></table>
          <h5 style="margin-top:14px;">Upcoming Jobs</h5>
          <table id="cpv-jobs"><thead><tr><th>Date</th><th>Description</th><th>Notes</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3>Employee Portal</h3>
        <div class="inline-fields">
          <div><label for="portal-employee-select">Employee</label><select id="portal-employee-select"></select></div>
          <div><label for="portal-employee-pin">PIN</label><input id="portal-employee-pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="****"/></div>
          <div><label>&nbsp;</label><button class="primary" id="open-employee-portal">Open Employee View</button></div>
        </div>

        <div id="employee-portal-view" class="hidden">
          <h4 id="epv-title"></h4>
          <div class="inline-fields" style="margin-top:8px">
            <div>
              <label>Clock</label><br/>
              <button class="primary" id="epv-clock-in">Clock In</button>
              <button class="secondary" id="epv-clock-out">Clock Out</button>
            </div>
          </div>
          <h5 style="margin-top:14px;">My Time Logs</h5>
          <table id="epv-timelogs"><thead><tr><th>Date</th><th>In</th><th>Out</th><th>Hours</th><th>Pay</th></tr></thead><tbody></tbody></table>
          <h5 style="margin-top:14px;">Today’s Jobs</h5>
          <table id="epv-jobs"><thead><tr><th>Date</th><th>Client</th><th>Description</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>
  </main>

<script>
/* ========================= Utilities & Storage ========================= */
const MAPBOX_TOKEN = 'REPLACE_WITH_YOUR_MAPBOX_TOKEN_IF_CHANGED';

function loadData(key, fallback){try{const d=localStorage.getItem(key);return d?JSON.parse(d):fallback}catch(e){return fallback}}
function saveData(key, val){localStorage.setItem(key, JSON.stringify(val))}
function generateId(){return Math.floor(Math.random()*1e9)}
function $(sel){return document.querySelector(sel)}

/* ========================= State ========================= */
let clients   = loadData('clients', []);
let services  = loadData('services', []);
let quotes    = loadData('quotes', []);
let jobs      = loadData('jobs', []);
let employees = loadData('employees', []);
let timelogs  = loadData('timelogs', []);
let invoices  = loadData('invoices', []);
let expenses  = loadData('expenses', []);
let leads     = loadData('leads', []);
let tasks     = loadData('tasks', []);

/* ========================= Navigation ========================= */
const sections = Array.from(document.querySelectorAll('main section'));
const navButtons = Array.from(document.querySelectorAll('nav button'));
function showSection(id){
  sections.forEach(s=>s.classList.toggle('active', s.id===id));
  navButtons.forEach(b=>b.classList.toggle('active', ('section-'+b.id.replace('nav-',''))===id));
}
navButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const target = 'section-'+btn.id.replace('nav-','');
    showSection(target);
    if (target==='section-clients') renderClients();
    if (target==='section-services') renderServices();
    if (target==='section-quotes') { updateClientSelects(); renderQuotes(); }
    if (target==='section-jobs') { updateClientSelects(); renderJobs(); }
    if (target==='section-employees') { renderEmployees(); renderTimeLogs(); }
    if (target==='section-invoices') renderInvoices();
    if (target==='section-expenses') renderExpenses();
    if (target==='section-leads') renderLeads();
    if (target==='section-tasks') renderTasks();
    if (target==='section-reports') renderReports();
    if (target==='section-portals') {
      portalPopulateClientSelect();
      portalPopulateEmployeeSelect();
      const params = new URLSearchParams(window.location.search);
      const cid = parseInt(params.get('client'));
      if (cid) { const sel=$('#portal-client-select'); if (sel) sel.value=cid; showClientPortal(cid); }
    }
  });
});

/* ========================= Clients ========================= */
function renderClients(){
  const tb = $('#clients-table tbody'); tb.innerHTML='';
  clients.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${c.name||''}</td><td>${c.company||''}</td><td>${c.email||''}</td><td>${c.phone||''}</td>
    <td class="actions">
    <button class="secondary" onclick="editClient(${c.id})">Edit</button>
    <button class="secondary" onclick="deleteClient(${c.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
$('#client-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id = $('#client-id').value;
  const name = $('#client-name').value.trim();
  if(!name) return;
  const payload = {
    name,
    company: $('#client-company').value.trim(),
    email: $('#client-email').value.trim(),
    phone: $('#client-phone').value.trim(),
    address: $('#client-address').value.trim(),
    lat: parseFloat($('#client-lat').value)||null,
    lng: parseFloat($('#client-lng').value)||null
  };
  if (id){
    const c = clients.find(x=>x.id==id); Object.assign(c, payload);
  } else {
    clients.push({id:generateId(), ...payload});
  }
  saveData('clients', clients);
  e.target.reset(); $('#client-id').value=''; $('#cancel-client-btn').classList.add('hidden');
  renderClients(); updateClientSelects();
});
$('#cancel-client-btn').addEventListener('click',()=>{ $('#client-form').reset(); $('#client-id').value=''; $('#cancel-client-btn').classList.add('hidden'); });
window.editClient = function(id){
  const c=clients.find(x=>x.id==id); if(!c) return;
  $('#client-id').value=c.id; $('#client-name').value=c.name||''; $('#client-company').value=c.company||'';
  $('#client-email').value=c.email||''; $('#client-phone').value=c.phone||''; $('#client-address').value=c.address||'';
  if (c.lat!=null) $('#client-lat').value=c.lat; if (c.lng!=null) $('#client-lng').value=c.lng;
  $('#cancel-client-btn').classList.remove('hidden');
}
window.deleteClient=function(id){ if(!confirm('Delete client?'))return; clients=clients.filter(c=>c.id!=id); saveData('clients',clients); renderClients(); updateClientSelects(); }

/* GPS: Use Current Location -> reverse geocode (Mapbox) */
$('#use-current-location').addEventListener('click', async ()=>{
  if(!navigator.geolocation){alert('Geolocation not supported');return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude, longitude}=pos.coords;
    $('#client-lat').value=latitude; $('#client-lng').value=longitude;
    try{
      const url=`https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${MAPBOX_TOKEN}`;
      const r = await fetch(url); const j = await r.json();
      const addr = (j.features && j.features[0] && j.features[0].place_name) || '';
      if(addr) $('#client-address').value=addr;
    }catch(e){ console.warn(e); }
  }, err=>alert('Location denied or unavailable'));
});

/* ========================= Services ========================= */
function renderServices(){
  const tb=$('#services-table tbody'); tb.innerHTML='';
  services.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>$${Number(s.price||0).toFixed(2)}</td><td>${s.description||''}</td>
    <td class="actions"><button class="secondary" onclick="editService(${s.id})">Edit</button>
    <button class="secondary" onclick="deleteService(${s.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
$('#service-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#service-id').value;
  const obj={ name:$('#service-name').value.trim(), price:parseFloat($('#service-price').value)||0, description:$('#service-description').value.trim()};
  if(!obj.name) return;
  if(id){const s=services.find(x=>x.id==id); Object.assign(s,obj);} else { services.push({id:generateId(),...obj}); }
  saveData('services',services); renderServices(); updateServiceSelects(); e.target.reset(); $('#service-id').value=''; $('#cancel-service-btn').classList.add('hidden');
});
$('#cancel-service-btn').addEventListener('click',()=>{ $('#service-form').reset(); $('#service-id').value=''; $('#cancel-service-btn').classList.add('hidden'); });
window.editService=function(id){const s=services.find(x=>x.id==id); if(!s)return; $('#service-id').value=s.id; $('#service-name').value=s.name; $('#service-price').value=s.price; $('#service-description').value=s.description; $('#cancel-service-btn').classList.remove('hidden');}
window.deleteService=function(id){ if(!confirm('Delete service?'))return; services=services.filter(s=>s.id!=id); saveData('services',services); renderServices(); updateServiceSelects(); }

/* Helpers to fill selects */
function updateClientSelects(){
  ['quote-client','job-client','invoice-client'].forEach(id=>{
    const sel = $('#'+id); if(!sel) return; sel.innerHTML='<option value="">Select client</option>'; clients.forEach(c=>{const o=document.createElement('option'); o.value=c.id;o.textContent=c.name; sel.appendChild(o);});
  });
}
function updateServiceSelects(){}

/* ========================= Quotes ========================= */
function renderQuotes(){
  const tb=$('#quotes-table tbody'); tb.innerHTML='';
  quotes.forEach(q=>{
    const c=clients.find(x=>x.id==q.clientId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c?c.name:''}</td><td>${q.date||''}</td><td>$${Number(q.total||0).toFixed(2)}</td><td>${q.status||'Draft'}</td>
    <td class="actions">
      <button class="secondary" onclick="editQuote(${q.id})">Edit</button>
      <button class="secondary" onclick="printQuote(${q.id})">Print</button>
      <button class="secondary" onclick="deleteQuote(${q.id})">Delete</button>
    </td>`;
    tb.appendChild(tr);
  });
}
function calcQuoteTotal(items){return items.reduce((s,it)=>s+(Number(it.qty||0)*Number(it.unit||0)),0)}
function rebuildQuoteItemsTable(items){
  const tb = $('#quote-items tbody'); tb.innerHTML='';
  items.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    const svcOpts = ['<option value="">Select</option>'].concat(services.map(s=>`<option value="${s.id}" ${s.id==it.serviceId?'selected':''}>${s.name}</option>`)).join('');
    tr.innerHTML=`<td><select data-i="${idx}" class="qi-service">${svcOpts}</select></td>
    <td><input class="qi-qty" data-i="${idx}" type="number" step="0.01" min="0" value="${it.qty||1}"></td>
    <td><input class="qi-unit" data-i="${idx}" type="number" step="0.01" min="0" value="${it.unit||0}"></td>
    <td>$${(Number(it.qty||0)*Number(it.unit||0)).toFixed(2)}</td>
    <td><button type="button" class="secondary" onclick="removeQuoteItem(${idx})">Remove</button></td>`;
    tb.appendChild(tr);
  });
  $('#quote-total').textContent = calcQuoteTotal(items).toFixed(2);
}
let currentQuoteItems=[];
function resetQuoteForm(){ currentQuoteItems=[]; rebuildQuoteItemsTable(currentQuoteItems); $('#quote-total').textContent='0.00'; }
$('#add-quote-item').addEventListener('click',()=>{ currentQuoteItems.push({serviceId:'',qty:1,unit:0}); rebuildQuoteItemsTable(currentQuoteItems); });
$('#quote-items').addEventListener('input',e=>{
  const i = Number(e.target.getAttribute('data-i')); if(isNaN(i))return;
  if(e.target.classList.contains('qi-service')) currentQuoteItems[i].serviceId = Number(e.target.value)||'';
  if(e.target.classList.contains('qi-qty')) currentQuoteItems[i].qty = Number(e.target.value)||0;
  if(e.target.classList.contains('qi-unit')) currentQuoteItems[i].unit = Number(e.target.value)||0;
  rebuildQuoteItemsTable(currentQuoteItems);
});
window.removeQuoteItem=function(i){ currentQuoteItems.splice(i,1); rebuildQuoteItemsTable(currentQuoteItems); }

$('#quote-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#quote-id').value;
  const obj={ clientId: Number($('#quote-client').value)||null, date: $('#quote-date').value||'', items: currentQuoteItems.slice(), notes: $('#quote-notes').value.trim(), total: calcQuoteTotal(currentQuoteItems), status:'Draft' };
  if(!obj.clientId) return alert('Choose a client');
  if(id){ const q=quotes.find(x=>x.id==id); Object.assign(q,obj); } else { quotes.push({id:generateId(),...obj}); }
  saveData('quotes',quotes); renderQuotes(); e.target.reset(); $('#quote-id').value=''; $('#cancel-quote-btn').classList.add('hidden'); resetQuoteForm();
});
window.editQuote=function(id){
  const q=quotes.find(x=>x.id==id); if(!q) return;
  $('#quote-id').value=q.id; $('#quote-client').value=q.clientId; $('#quote-date').value=q.date||''; $('#quote-notes').value=q.notes||''; currentQuoteItems = (q.items||[]).map(x=>({...x})); rebuildQuoteItemsTable(currentQuoteItems); $('#cancel-quote-btn').classList.remove('hidden');
}
window.deleteQuote=function(id){ if(!confirm('Delete quote?'))return; quotes=quotes.filter(q=>q.id!=id); saveData('quotes',quotes); renderQuotes(); }

/* Quote print (professional layout variant) */
window.printQuote=function(id){
  const q=quotes.find(x=>x.id==id); if(!q) return alert('Quote not found');
  const client = clients.find(c=>c.id==q.clientId);
  const rows = (q.items||[]).map(it=>{
    const svc = services.find(s=>s.id==it.serviceId);
    const name = svc?svc.name:'(Service)';
    const unit = Number(it.unit||0);
    const qty  = Number(it.qty||0);
    return `<tr><td>${name}</td><td style="text-align:right">${qty.toFixed(2)}</td><td style="text-align:right">$${unit.toFixed(2)}</td><td style="text-align:right">$${(qty*unit).toFixed(2)}</td></tr>`;
  }).join('');
  const total = Number(q.total||0);
  const acceptance = total*0.20, mobilization=total*0.30, completion=total*0.40, warranty=total*0.10;

  const win = window.open('', '_blank');
  win.document.write(`
  <html><head><title>Quote</title>
  <style>
  body{font-family:Arial;margin:24px;color:#222}
  h1{margin:0 0 10px}
  .hdr{display:flex;justify-content:space-between;align-items:flex-end;border-bottom:3px solid #2a9d8f;padding-bottom:10px;margin-bottom:16px}
  .muted{opacity:.75}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #ccc;padding:6px}
  th{background:#e9f5f3;text-align:left}
  .right{text-align:right}
  .box{border:1px solid #ccc;padding:8px}
  </style></head><body>
  <div class="hdr">
    <div><h1>LAWN CARE QUOTE</h1><div class="muted">Quote ID: ${q.id} • Date: ${q.date||''}</div></div>
    <div class="muted">${client?client.name:''}<br/>${client?client.address||'': ''}</div>
  </div>

  <div class="grid">
    <div>
      <h3>Services</h3>
      <table>
        <thead><tr><th>Service</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Total</th></tr></thead>
        <tbody>${rows || '<tr><td colspan="4">(no items)</td></tr>'}</tbody>
      </table>

      <h3 style="margin-top:12px">Materials</h3>
      <table>
        <thead><tr><th>Material</th><th class="right">Cost</th></tr></thead>
        <tbody><tr><td>(included)</td><td class="right">$0.00</td></tr></tbody>
      </table>
    </div>

    <div>
      <h3>Work Description</h3>
      <div class="box">${(q.notes && q.notes.replace(/\\n/g,'<br/>')) || (q.items||[]).map(it=>{const s=services.find(x=>x.id==it.serviceId);return s?('• '+s.name):'';}).join('<br/>')}</div>

      <h3 style="margin-top:12px">Schedule</h3>
      <div class="box">Mobilization within 5 business days of acceptance. Estimated duration 1–3 working days.</div>

      <h3 style="margin-top:12px">Payment Terms</h3>
      <table>
        <thead><tr><th>Milestone</th><th class="right">Amount</th></tr></thead>
        <tbody>
          <tr><td>20% Acceptance</td><td class="right">$${acceptance.toFixed(2)}</td></tr>
          <tr><td>30% Mobilization</td><td class="right">$${mobilization.toFixed(2)}</td></tr>
          <tr><td>40% Completion</td><td class="right">$${completion.toFixed(2)}</td></tr>
          <tr><td>10% Warranty</td><td class="right">$${warranty.toFixed(2)}</td></tr>
        </tbody>
      </table>

      <h3 style="margin-top:12px">Cost Summary (USD)</h3>
      <table>
        <tbody>
          <tr><th>Labor</th><td class="right">$${total.toFixed(2)}</td></tr>
          <tr><th>Materials</th><td class="right">$0.00</td></tr>
          <tr><th>Total</th><td class="right"><strong>$${total.toFixed(2)}</strong></td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <p class="muted" style="margin-top:16px">Thank you for the opportunity to quote your project.</p>
  <script>window.onload=()=>window.print()</script>
  </body></html>`);
  win.document.close();
}

/* ========================= Jobs ========================= */
function renderJobs(){
  const tb=$('#jobs-table tbody'); tb.innerHTML='';
  jobs.forEach(j=>{
    const c=clients.find(x=>x.id==j.clientId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.date||''}</td><td>${c?c.name:''}</td><td>${j.description||''}</td>
    <td class="actions"><button class="secondary" onclick="editJob(${j.id})">Edit</button><button class="secondary" onclick="deleteJob(${j.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
$('#job-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#job-id').value;
  const obj={ clientId: Number($('#job-client').value)||null, date: $('#job-date').value||'', description: $('#job-desc').value.trim() };
  if(!obj.clientId) return alert('Choose a client');
  if(id){ const j=jobs.find(x=>x.id==id); Object.assign(j,obj); } else { jobs.push({id:generateId(),...obj}); }
  saveData('jobs',jobs); renderJobs(); e.target.reset(); $('#job-id').value=''; $('#cancel-job-btn').classList.add('hidden');
});
window.editJob=function(id){const j=jobs.find(x=>x.id==id); if(!j) return; $('#job-id').value=j.id; $('#job-client').value=j.clientId; $('#job-date').value=j.date||''; $('#job-desc').value=j.description||''; $('#cancel-job-btn').classList.remove('hidden');}
window.deleteJob=function(id){ if(!confirm('Delete job?'))return; jobs=jobs.filter(j=>j.id!=id); saveData('jobs',jobs); renderJobs(); }

/* ========================= Employees & Time ========================= */
function renderEmployees(){
  const tb=$('#employees-table tbody'); tb.innerHTML='';
  employees.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.name}</td><td>${e.role||''}</td><td>${(e.hourlyRate!=null)?Number(e.hourlyRate).toFixed(2):''}</td>
    <td class="actions"><button class="secondary" onclick="editEmployee(${e.id})">Edit</button><button class="secondary" onclick="deleteEmployee(${e.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
  updateClockEmployeeSelect();
}
function updateClockEmployeeSelect(){
  const sel=$('#clock-employee'); if(!sel) return; sel.innerHTML='<option value="">Select employee</option>';
  employees.forEach(e=>{const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; sel.appendChild(o);});
}
$('#employee-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#employee-id').value;
  const obj={ name:$('#employee-name').value.trim(), role:$('#employee-role').value.trim(), hourlyRate:parseFloat($('#employee-rate').value)||0, pin:($('#employee-pin').value||'').trim() };
  if(!obj.name) return;
  if(id){const emp=employees.find(x=>x.id==id); Object.assign(emp,obj);} else { employees.push({id:generateId(),...obj}); }
  saveData('employees',employees); renderEmployees(); e.target.reset(); $('#employee-id').value=''; $('#cancel-employee-btn').classList.add('hidden');
});
$('#cancel-employee-btn').addEventListener('click',()=>{$('#employee-form').reset(); $('#employee-id').value=''; $('#cancel-employee-btn').classList.add('hidden');});
window.editEmployee=function(id){const e=employees.find(x=>x.id==id); if(!e) return; $('#employee-id').value=e.id; $('#employee-name').value=e.name; $('#employee-role').value=e.role||''; $('#employee-rate').value=(e.hourlyRate!=null?e.hourlyRate:''); $('#employee-pin').value=e.pin||''; $('#cancel-employee-btn').classList.remove('hidden');}
window.deleteEmployee=function(id){ if(!confirm('Delete employee?'))return; employees=employees.filter(e=>e.id!=id); timelogs=timelogs.filter(t=>t.employeeId!=id); saveData('employees',employees); saveData('timelogs',timelogs); renderEmployees(); renderTimeLogs();}

/* Clock */
$('#clock-in-btn').addEventListener('click',()=>{ const empId=parseInt($('#clock-employee').value); if(!empId) return alert('Select an employee'); const open=timelogs.find(t=>t.employeeId==empId && !t.clockOut); if(open) return alert('Already clocked in'); const now=new Date(); timelogs.push({id:generateId(), employeeId:empId, date:now.toISOString().slice(0,10), clockIn:now.toISOString(), clockOut:null, hours:null, pay:null}); saveData('timelogs',timelogs); renderTimeLogs();});
$('#clock-out-btn').addEventListener('click',()=>{ const empId=parseInt($('#clock-employee').value); if(!empId) return alert('Select an employee'); const open=timelogs.find(t=>t.employeeId==empId && !t.clockOut); if(!open) return alert('Not clocked in'); const now=new Date(); open.clockOut=now.toISOString(); const start=new Date(open.clockIn); open.hours=(now-start)/(1000*60*60); const emp=employees.find(e=>e.id==empId); const rate=emp?parseFloat(emp.hourlyRate)||0:0; open.pay=(open.hours||0)*rate; saveData('timelogs',timelogs); renderTimeLogs();});
function renderTimeLogs(){
  const tb=$('#timelogs-table tbody'); tb.innerHTML='';
  timelogs.forEach(l=>{ const e=employees.find(x=>x.id==l.employeeId); const tr=document.createElement('tr'); tr.innerHTML=`<td>${e?e.name:''}</td><td>${l.date||''}</td><td>${l.clockIn?new Date(l.clockIn).toLocaleTimeString():''}</td><td>${l.clockOut?new Date(l.clockOut).toLocaleTimeString():''}</td><td>${l.hours?Number(l.hours).toFixed(2):''}</td><td>${l.pay!=null?Number(l.pay).toFixed(2):''}</td><td class="actions"><button class="secondary" onclick="editTimeLog(${l.id})">Edit</button><button class="secondary" onclick="deleteTimeLog(${l.id})">Delete</button></td>`; tb.appendChild(tr); });
}
window.deleteTimeLog=function(id){ if(!confirm('Delete time log?'))return; timelogs=timelogs.filter(l=>l.id!=id); saveData('timelogs',timelogs); renderTimeLogs(); }
window.editTimeLog=function(id){const l=timelogs.find(x=>x.id==id); if(!l)return; $('#edit-timelog-id').value=l.id; $('#edit-timelog-date').value=l.date||''; $('#edit-timelog-start').value=l.clockIn?new Date(l.clockIn).toISOString().slice(11,16):''; $('#edit-timelog-end').value=l.clockOut?new Date(l.clockOut).toISOString().slice(11,16):''; $('#edit-timelog-hours').value=(l.hours!=null?Number(l.hours).toFixed(2):''); $('#timelog-edit-modal').classList.remove('hidden'); }
$('#cancel-timelog-edit-btn').addEventListener('click',()=>$('#timelog-edit-modal').classList.add('hidden'));
$('#timelog-edit-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=parseInt($('#edit-timelog-id').value); const log=timelogs.find(l=>l.id==id); if(!log)return;
  const date=$('#edit-timelog-date').value; const st=$('#edit-timelog-start').value; const en=$('#edit-timelog-end').value; const hoursVal=parseFloat($('#edit-timelog-hours').value);
  if(date){ log.date=date; }
  if(st){ log.clockIn=new Date(date+'T'+st).toISOString(); }
  if(en){ log.clockOut=new Date(date+'T'+en).toISOString(); }
  if(!isNaN(hoursVal)){ log.hours=hoursVal; } else if (log.clockIn && log.clockOut){ log.hours=(new Date(log.clockOut)-new Date(log.clockIn))/(1000*60*60); }
  const emp=employees.find(e=>e.id==log.employeeId); const rate=emp?parseFloat(emp.hourlyRate)||0:0; log.pay=(log.hours||0)*rate;
  saveData('timelogs',timelogs); renderTimeLogs(); $('#timelog-edit-modal').classList.add('hidden');
});

/* ========================= Invoices ========================= */
function renderInvoices(){
  const tb=$('#invoices-table tbody'); tb.innerHTML='';
  (invoices||[]).forEach((inv,i)=>{
    const c=clients.find(x=>x.id==inv.clientId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${inv.date||''}</td><td>${c?c.name:''}</td><td>$${Number(inv.total||0).toFixed(2)}</td><td>${inv.status||'Unpaid'}</td>
    <td class="actions"><button class="secondary" onclick="openInvoice(${inv.id})">Open</button><button class="secondary" onclick="deleteInvoice(${inv.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
$('#new-invoice-btn').addEventListener('click',()=>{ openInvoice(null); });
function openInvoice(id){
  $('#invoice-modal').classList.remove('hidden');
  $('#invoice-items tbody').innerHTML=''; $('#invoice-total').textContent='0.00';
  $('#invoice-id').value=''; $('#invoice-date').value=''; $('#invoice-status').value='Unpaid';
  $('#invoice-client').innerHTML='<option value="">Select client</option>'; clients.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;$('#invoice-client').appendChild(o);});
  if(id!=null){ const inv=invoices.find(x=>x.id==id); if(inv){ $('#invoice-id').value=inv.id; $('#invoice-client').value=inv.clientId; $('#invoice-date').value=inv.date||''; $('#invoice-status').value=inv.status||'Unpaid'; (inv.items||[]).forEach(it=>addInvoiceItem(it.serviceId,it.qty,it.unit)); updateInvoiceTotal(); } }
}
$('#cancel-invoice-btn').addEventListener('click',()=>$('#invoice-modal').classList.add('hidden'));
$('#add-invoice-item').addEventListener('click',()=>addInvoiceItem('',1,0));
function addInvoiceItem(serviceId,qty,unit){
  # NOTE: this function will be fixed shortly if syntax error occurs
}

  const tb=$('#invoice-items tbody'); const tr=document.createElement('tr');
  const svcOpts=['<option value="">Select</option>'].concat(services.map(s=>`<option value="${s.id}" ${s.id==serviceId?'selected':''}>${s.name}</option>`)).join('');
  tr.innerHTML=`<td><select class="inv-svc">${svcOpts}</select></td>
    <td><input class="inv-qty" type="number" step="0.01" min="0" value="${qty}"></td>
    <td><input class="inv-unit" type="number" step="0.01" min="0" value="${unit}"></td>
    <td class="inv-line">$${(qty*unit).toFixed(2)}</td>
    <td><button type="button" class="secondary inv-remove">Remove</button></td>`;
  tb.appendChild(tr); updateInvoiceTotal();
}
$('#invoice-items').addEventListener('input',e=>{
  const tr=e.target.closest('tr'); if(!tr) return;
  const qty=Number(tr.querySelector('.inv-qty').value)||0;
  const unit=Number(tr.querySelector('.inv-unit').value)||0;
  tr.querySelector('.inv-line').textContent='$'+(qty*unit).toFixed(2);
  updateInvoiceTotal();
});
$('#invoice-items').addEventListener('click',e=>{
  if(e.target.classList.contains('inv-remove')){ e.target.closest('tr').remove(); updateInvoiceTotal(); }
});
function updateInvoiceTotal(){
  let sum=0; document.querySelectorAll('#invoice-items tbody tr').forEach(tr=>{ const qty=Number(tr.querySelector('.inv-qty').value)||0; const unit=Number(tr.querySelector('.inv-unit').value)||0; sum+=qty*unit; });
  $('#invoice-total').textContent=sum.toFixed(2);
}
$('#invoice-form').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#invoice-id').value||null;
  const clientId=Number($('#invoice-client').value)||null; if(!clientId) return alert('Choose a client');
  const items=[]; document.querySelectorAll('#invoice-items tbody tr').forEach(tr=>{ const svc=Number(tr.querySelector('.inv-svc').value)||null; const qty=Number(tr.querySelector('.inv-qty').value)||0; const unit=Number(tr.querySelector('.inv-unit').value)||0; items.push({serviceId:svc,qty,unit});});
  const total=Number($('#invoice-total').textContent)||0;
  const invObj={ id:id?Number(id):generateId(), clientId, date:$('#invoice-date').value||'', items, total, status:$('#invoice-status').value||'Unpaid' };
  if(id){ const i=invoices.findIndex(x=>x.id==invObj.id); invoices[i]=invObj; } else { invoices.push(invObj); }
  saveData('invoices',invoices); $('#invoice-modal').classList.add('hidden'); renderInvoices();
});
window.deleteInvoice=function(id){ if(!confirm('Delete invoice?'))return; invoices=invoices.filter(i=>i.id!=id); saveData('invoices',invoices); renderInvoices(); }

/* ========================= Expenses ========================= */
function renderExpenses(){
  const tb=$('#expenses-table tbody'); tb.innerHTML='';
  (expenses||[]).forEach(ex=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ex.date||''}</td><td>${ex.desc||''}</td><td>$${Number(ex.amount||0).toFixed(2)}</td>
    <td class="actions"><button class="secondary" onclick="deleteExpense(${ex.id})">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
$('#expense-form').addEventListener('submit',e=>{
  e.preventDefault();
  const ex={ id:generateId(), date:$('#expense-date').value||'', desc:$('#expense-desc').value.trim(), amount:parseFloat($('#expense-amount').value)||0 };
  expenses.push(ex); saveData('expenses',expenses); renderExpenses(); e.target.reset();
});
window.deleteExpense=function(id){ if(!confirm('Delete expense?'))return; expenses=expenses.filter(x=>x.id!=id); saveData('expenses',expenses); renderExpenses(); }

/* ========================= Leads / Tasks ========================= */
function renderLeads(){ const tb=$('#leads-table tbody'); tb.innerHTML=''; (leads||[]).forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.name||''}</td><td>${l.contact||''}</td><td>${l.notes||''}</td><td class="actions"><button class="secondary" onclick="deleteLead(${l.id})">Delete</button></td>`; tb.appendChild(tr);});}
$('#lead-form').addEventListener('submit',e=>{e.preventDefault(); const l={id:generateId(), name:$('#lead-name').value.trim(), contact:$('#lead-contact').value.trim(), notes:$('#lead-notes').value.trim()}; if(!l.name)return; leads.push(l); saveData('leads',leads); renderLeads(); e.target.reset();});
window.deleteLead=function(id){ if(!confirm('Delete lead?'))return; leads=leads.filter(l=>l.id!=id); saveData('leads',leads); renderLeads(); }

function renderTasks(){ const tb=$('#tasks-table tbody'); tb.innerHTML=''; (tasks||[]).forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.title||''}</td><td>${t.due||''}</td><td>${t.completed?'Done':'Open'}</td><td class="actions"><button class="secondary" onclick="completeTask(${t.id})">Complete</button><button class="secondary" onclick="deleteTask(${t.id})">Delete</button></td>`; tb.appendChild(tr);});}
$('#task-form').addEventListener('submit',e=>{e.preventDefault(); const t={id:generateId(), title:$('#task-title').value.trim(), due:$('#task-due').value||'', completed:false}; if(!t.title)return; tasks.push(t); saveData('tasks',tasks); renderTasks(); e.target.reset();});
window.completeTask=function(id){ const t=tasks.find(x=>x.id==id); if(t){ t.completed=true; saveData('tasks',tasks); renderTasks(); } }
window.deleteTask=function(id){ if(!confirm('Delete task?'))return; tasks=tasks.filter(t=>t.id!=id); saveData('tasks',tasks); renderTasks(); }

/* ========================= Reports ========================= */
function renderReports(){
  const numClients=clients.length;
  const numQuotes=quotes.length;
  const totalQuoteRevenue = quotes.reduce((s,q)=>s+(q.total||0),0);
  const numJobs=jobs.length;
  const totalHours=(timelogs||[]).reduce((s,l)=>s+(l.hours||0),0);
  const totalPayroll=(timelogs||[]).reduce((s,l)=>s+(parseFloat(l.pay)||0),0);
  const invRevenue=(invoices||[]).reduce((s,i)=>s+(i.total||0),0);
  const invPaid=(invoices||[]).filter(i=>i.status==='Paid').reduce((s,i)=>s+(i.total||0),0);
  const invOutstanding=invRevenue-invPaid;
  const totalExpenses=(expenses||[]).reduce((s,e)=>s+(e.amount||0),0);
  const profitBeforePayroll = invRevenue - totalExpenses;
  const profitAfterPayroll = invRevenue - totalExpenses - totalPayroll;

  $('#report-content').innerHTML = `
    <p><strong>Total Clients:</strong> ${numClients}</p>
    <p><strong>Total Quotes:</strong> ${numQuotes}</p>
    <p><strong>Total Revenue (Quotes):</strong> $${totalQuoteRevenue.toFixed(2)}</p>
    <p><strong>Total Jobs:</strong> ${numJobs}</p>
    <p><strong>Total Hours Logged:</strong> ${totalHours.toFixed(2)}</p>
    <p><strong>Total Payroll (Time Logs):</strong> $${totalPayroll.toFixed(2)}</p>
    <hr/>
    <p><strong>Invoice Revenue:</strong> $${invRevenue.toFixed(2)}</p>
    <p><strong>Paid:</strong> $${invPaid.toFixed(2)} &nbsp; <strong>Outstanding:</strong> $${invOutstanding.toFixed(2)}</p>
    <p><strong>Expenses:</strong> $${totalExpenses.toFixed(2)}</p>
    <p><strong>Profit (before payroll):</strong> $${profitBeforePayroll.toFixed(2)}</p>
    <p><strong>Profit (after payroll):</strong> $${profitAfterPayroll.toFixed(2)}</p>
  `;
}

/* ========================= Portals ========================= */
function portalPopulateClientSelect(){
  const sel=$('#portal-client-select'); if(!sel) return; sel.innerHTML='<option value="">Select client</option>';
  clients.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.name||('Client #'+c.id); sel.appendChild(o);});
}
function portalPopulateEmployeeSelect(){
  const sel=$('#portal-employee-select'); if(!sel) return; sel.innerHTML='<option value="">Select employee</option>';
  employees.forEach(e=>{const o=document.createElement('option'); o.value=e.id; o.textContent=e.name; sel.appendChild(o);});
}
$('#open-client-portal').addEventListener('click',()=>{ const id=parseInt($('#portal-client-select').value); if(!id) return; showClientPortal(id); });
function showClientPortal(clientId){
  const client=clients.find(c=>c.id==clientId);
  $('#client-portal-view').classList.remove('hidden');
  $('#cpv-title').textContent= (client?client.name:'Client') + ' — Client View';

  // quotes
  const qt=$('#cpv-quotes tbody'); qt.innerHTML='';
  quotes.filter(q=>q.clientId==clientId).forEach(q=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${q.date||''}</td><td>$${Number(q.total||0).toFixed(2)}</td><td>${q.status||'Draft'}</td>
    <td>${q.status==='Accepted'?'':`<button class="secondary" onclick="clientApproveQuote(${q.id})">Approve</button>`}
        <button class="secondary" onclick="printQuote(${q.id})">Print</button></td>`;
    qt.appendChild(tr);
  });

  // invoices
  const it=$('#cpv-invoices tbody'); it.innerHTML='';
  (invoices||[]).filter(i=>i.clientId==clientId).forEach(i=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i.date||''}</td><td>$${Number(i.total||0).toFixed(2)}</td><td>${i.status||'Unpaid'}</td>`;
    it.appendChild(tr);
  });

  // jobs
  const jt=$('#cpv-jobs tbody'); jt.innerHTML='';
  (jobs||[]).filter(j=>j.clientId==clientId).forEach(j=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.date||''}</td><td>${j.description||''}</td><td>${(client&&client.address)||''}</td>`;
    jt.appendChild(tr);
  });
}
window.clientApproveQuote=function(quoteId){
  const q=quotes.find(x=>x.id==quoteId); if(!q) return; q.status='Accepted'; q.approvedAt=new Date().toISOString(); saveData('quotes',quotes);
  const sel=$('#portal-client-select'); if(sel && sel.value) showClientPortal(parseInt(sel.value));
  alert('Quote approved. Thank you!');
}

$('#open-employee-portal').addEventListener('click',()=>{
  const id=parseInt($('#portal-employee-select').value);
  const pin=($('#portal-employee-pin').value||'').trim();
  if(!id||!pin) return;
  const emp=employees.find(e=>e.id==id);
  if(!emp || (emp.pin||'')!==pin) return alert('Invalid PIN');
  showEmployeePortal(id);
});
function showEmployeePortal(employeeId){
  const emp=employees.find(e=>e.id==employeeId);
  $('#employee-portal-view').classList.remove('hidden');
  $('#epv-title').textContent=(emp?emp.name:'Employee')+' — Employee View';

  $('#epv-clock-in').onclick = ()=>clockEmployeeIn(employeeId);
  $('#epv-clock-out').onclick= ()=>clockEmployeeOut(employeeId);

  const ttb=$('#epv-timelogs tbody'); ttb.innerHTML='';
  timelogs.filter(t=>t.employeeId==employeeId).forEach(t=>{
    const ci=t.clockIn?new Date(t.clockIn).toLocaleTimeString():'';
    const co=t.clockOut?new Date(t.clockOut).toLocaleTimeString():'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.date||''}</td><td>${ci}</td><td>${co}</td><td>${t.hours?Number(t.hours).toFixed(2):''}</td><td>${t.pay!=null?Number(t.pay).toFixed(2):''}</td>`;
    ttb.appendChild(tr);
  });

  const today=new Date().toISOString().slice(0,10);
  const jtb=$('#epv-jobs tbody'); jtb.innerHTML='';
  (jobs||[]).filter(j=>j.date===today).forEach(j=>{
    const name=(clients.find(c=>c.id==j.clientId)||{}).name||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.date||''}</td><td>${name}</td><td>${j.description||''}</td>`;
    jtb.appendChild(tr);
  });
}
function clockEmployeeIn(employeeId){
  const open=timelogs.find(l=>l.employeeId==employeeId&&!l.clockOut);
  if(open) return alert('Already clocked in');
  const now=new Date();
  timelogs.push({id:generateId(),employeeId,date:now.toISOString().slice(0,10),clockIn:now.toISOString(),clockOut:null,hours:null,pay:null});
  saveData('timelogs',timelogs); showEmployeePortal(employeeId);
}
function clockEmployeeOut(employeeId){
  const open=timelogs.find(l=>l.employeeId==employeeId&&!l.clockOut);
  if(!open) return alert('Not clocked in');
  const now=new Date(); open.clockOut=now.toISOString();
  open.hours=(now-new Date(open.clockIn))/(1000*60*60);
  const emp=employees.find(e=>e.id==employeeId); const rate=emp?parseFloat(emp.hourlyRate)||0:0; open.pay=(open.hours||0)*rate;
  saveData('timelogs',timelogs); showEmployeePortal(employeeId);
}

/* ========================= Init ========================= */
function renderInvoicesOnStart(){ if($('#invoices-table')) renderInvoices(); }
function renderExpensesOnStart(){ if($('#expenses-table')) renderExpenses(); }
function renderLeadsOnStart(){ if($('#leads-table')) renderLeads(); }
function renderTasksOnStart(){ if($('#tasks-table')) renderTasks(); }

renderClients(); renderServices(); updateClientSelects(); renderQuotes(); renderJobs();
renderEmployees(); renderTimeLogs(); renderInvoicesOnStart(); renderExpensesOnStart(); renderLeadsOnStart(); renderTasksOnStart(); renderReports();
portalPopulateClientSelect(); portalPopulateEmployeeSelect();
</script>
</body>
</html>
